**【メダロットE】解説書**


**1. プロジェクト概要**

このプロジェクトは、人気ゲーム「メダロット」の戦闘システムをリスペクトした、EbitenとECS（エンティティ・コンポーネント・システム）アーキテクチャによるバトルシミュレーションゲームです。
ECSライブラリには donburi を採用しており、データ指向の設計に基づいています。



**2. ディレクトリ・ファイル構成と役割**

[main.go]

役割:アプリケーションのエントリーポイント（起動点）

・設定ファイル (config.json) やゲームデータ (csv) の読み込み。

・Ebitenのウィンドウ設定

・Game構造体の初期化と、ゲームループの開始 (ebiten.RunGame) を行います.


・プログラム全体の起動と終了に関わる処理を担当します。


[game.go]

役割:ゲーム全体の進行管理と状態保持。

・Game構造体を定義し、ゲームの核となるdonburi.WorldやUI、現在のゲーム状態 (StatePlaying, StateGameOverなど) を保持します。

・Update()メソッドで、毎フレームのゲームロジック（各システムの実行）とUI更新を制御します。Draw()メソッドで、描画処理の起点となります。


[types.go]

役割:プロジェクト全体で利用される基本的な型定義。

・ゲームの状態 (GameState)、チームID (TeamID)、パーツのスロット (PartSlotKey) など、複数のファイルで共通して使われる列挙型や型エイリアスを定義しています。

・ここで型を集中管理することで、コード全体の一貫性を保ちます。



**3. ECS（エンティティ・コンポーネント・システム）関連**

[components.go]

役割:ECSの「コンポーネント」を定義。

・メダロットを構成する全てのデータ（Settings, Parts, State, Gaugeなど）を構造体として定義します。

・各コンポーネントに対応するdonburi.ComponentTypeもここで生成します。これらは、エンティティからコンポーネントデータを取得・設定するためのキーとなります。


[ecs_setup.go]

役割:ゲーム開始時のエンティティ生成。

・CSVから読み込んだデータをもとに、ゲーム世界のエンティティ（メダロットたち）を生成し、必要なコンポーネントをアタッチ（追加）します。

・CreateMedarotEntities関数がその中心的な役割を担います。


[systems.go]

役割:ECSの「システム」を定義。ゲームの具体的なロジック。

・「メダロットのゲージを進める」「準備完了したメダロットの行動を処理する」「AIが次に行う行動を決定する」といった、具体的なゲームルールを関数（システム）として実装しています。

・各システムは、donburi.Queryを使って特定のコンポーネントを持つエンティティ群を抽出し、それらに対して処理を行います。



**4. ゲームロジック・データ関連**

[battle_logic.go]

役割: 戦闘計算のコアロジック。

・ダメージ計算 (CalculateDamage)、命中判定 (CalculateHit)、ダメージを受けるパーツの選択 (SelectRandomPartToDamage) など、戦闘における汎用的な計算処理をまとめています。

・これらの関数は、主にsystems.goから呼び出されます。


[ai.go]
役割:敵（AI）の思考ルーチン。

・AIが操作するメダロットが、どのパーツでどの敵を攻撃するかを決定するロジックを実装しています。

・aiSelectAction関数が中心となり、ターゲット候補のリストアップと最終的なターゲットの決定を行います。

[csv_loader.go]

役割: CSV形式のゲームデータの読み込み。

・dataディレクトリに配置されたメダロット、パーツ、メダルのCSVファイルを読み込み、プログラムで扱いやすい構造体に変換します。


[config.go]

役割:設定ファイル (config.json) の読み込みと管理。

・ゲームのバランス調整値やUIの表示設定など、ハードコーディングしたくない値を外部ファイルから読み込むための処理を定義しています。



**5. UI（ユーザーインターフェース）関連**

[ui.go]

役割:UI全体の構築と管理。

・UI構造体を定義し、画面上の全てのUI要素（情報パネル、バトルフィールド、モーダルウィンドウなど）を統括します。

・NewUI関数で、ゲーム画面のレイアウトを構築します。


[battlefield_widget.go]

役割:中央のバトルフィールド描画。

・メダロットの位置を示すアイコンの描画や、その位置の更新ロジックを管理します。

・各メダロットのStateやGaugeコンポーネントに応じて、アイコンの見た目や位置が変化します。


[ui_info_panels.go]

役割:左右のメダロット情報パネルの描画と更新。

・各メダロットのパーツHPやステータスを表示するパネルの生成と、毎フレームのデータ更新処理を行います。


[ui_action_modal.go]

プレイヤーが行動を選択するためのモーダルウィンドウ。

・プレイヤーが操作するメダロットの行動準備が完了した際に表示される、攻撃パーツ選択用のUIを構築します。


[ui_message_window.go]

役割:画面下部に表示されるメッセージウィンドウ。

・「〜にXXダメージ！」といった戦闘ログを表示するためのUIを構築します。
