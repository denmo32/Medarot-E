**【メダロットE】解説書**


**プロジェクト概要**

このプロジェクトは、人気ゲーム「メダロット」の戦闘システムをリスペクトした、EbitenとECS（エンティティ・コンポーネント・システム）アーキテクチャによるバトルシミュレーションゲームです。
ECSライブラリには donburi を採用しており、データ指向の設計に基づいています。


Core & Entry Point (中核・起動)

    main.go

        役割: プログラムの起動点（エントリーポイント）。

        内容: ウィンドウの初期化、フォントや設定ファイルの読み込み、ゲーム全体のメインループの開始。

    game.go

        役割: ゲーム全体のシーン（画面）を管理するシーンマネージャー。

        内容: 現在のシーンを保持し、シーン間の遷移（例：タイトル→バトル）を制御する。UpdateとDrawの司令塔。

    config.go

        役割: ゲームの固定設定値を管理する。

        内容: ゲームバランス（攻撃力係数など）、UIのサイズや色といった、マジックナンバーになりがちな値を一元管理する。

Scene (各画面の実装)

    scene.go

        役割: すべてのシーンが満たすべき共通のルール（インターフェース）を定義。

        内容: Update, Drawメソッドの型定義。シーン間で共有するリソース（SharedResources）の定義。

    scene_title.go

        役割: タイトル画面の実装。

    scene_battle.go

        役割: 戦闘シーンの統括。

        内容: 戦闘用のWorld（ECS）、UI、ゲーム状態（StatePlaying, StateGameOverなど）を管理し、各戦闘システム（後述）を適切なタイミングで呼び出す。戦闘の進行そのもののロジックの多くは、各種戦闘システムファイルに移譲されている。

    scene_customize.go

        役割: メダロットのカスタマイズ画面の実装。

    scene_placeholder.go

        役割: 未実装画面などのための、汎用的なプレースホルダー画面。

ECS (エンティティ・コンポーネント・システム)

    components.go

        役割: [データ] の定義。ECSの「C（コンポーネント）」。

        内容: エンティティを構成する部品（Settings, Parts, Gaugeなど）や、状態を示すタグ（IdleState, DefenseDebuff, ActingWithBerserkTraitTag, JustBecameIdleTagなど）、AI戦略コンポーネント（TargetingStrategyComponent, AIPartSelectionStrategyComponent）、戦闘計算修飾コンポーネント（ActionModifierComponent）のデータ構造をすべて定義する。新しいデータ、状態、エンティティに持たせる特性を追加したい場合は、まずこのファイルを編集する。

    action_queue_component.go

        役割: [データ] 戦闘中の行動実行待ちキューを保持するコンポーネントの定義。

        内容: `ActionQueueComponentData` 構造体（行動するエンティティのキューを持つ）と、それに関連するComponentType、取得・初期化用関数を定義する。ワールドに一つ存在する専用エンティティがこのコンポーネントを持つ。行動実行の順序制御に関わるデータを変更する場合に編集する。

    ecs_setup.go

        役割: 戦闘開始時のエンティティ生成と初期コンポーネント設定。

        内容: CSVから読み込んだデータをもとに、戦闘に参加する全メダロットのエンティティと、その初期状態に必要な各種コンポーネント（Settings, Parts, Medal, AI戦略コンポーネント等）を作成・設定する。新しいコンポーネントをエンティティの初期状態に追加する場合や、初期設定ロジックを変更する場合に編集する。

    systems.go

        役割: [ロジック/振る舞い] ECSの「S（システム）」のうち、汎用的またはまだ分類されていない小規模なもの。

        内容: かつては多くの戦闘ロジックを含んでいたが、リファクタリングにより主要な戦闘システムは後述の専用ファイルに移管された。現在は、行動開始処理 (`StartCharge`) など、複数のシステムから呼び出される可能性のあるユーティリティ的な戦闘関連関数や、ごく小規模なシステムが残る場合がある。特定のカテゴリに分類しにくい新しい小規模システムを追加する場合などに編集する可能性がある。

    action_modifier_system.go

        役割: [ロジック/振る舞い] 行動実行時の戦闘計算修飾システム。

        内容: `ApplyActionModifiersSystem`（行動直前に特性やスキルに応じた攻撃力・命中・クリティカル補正などを計算し `ActionModifierComponent` を付与）と `RemoveActionModifiersSystem`（行動後に同コンポーネントを除去）を定義。パーツ特性やメダルスキルによる戦闘計算への影響を変更・追加する場合に編集する。

    action_queue_system.go

        役割: [ロジック/振る舞い] 行動実行キューの処理と、実際のアクション実行ロジック。

        内容: `UpdateActionQueueSystem`（行動準備完了キューを処理しソートする）、`executeActionLogic`（単一の行動のターゲット解決、命中判定、ダメージ計算、結果適用を行う中心ロジック）、`StartCooldownSystem`（行動後のクールダウン開始処理）、`StartCharge`（行動のチャージ開始処理、特性タグ付与なども含む）を定義。行動の実行シーケンスや、実行キューの処理方法を変更する場合に編集する。

    action_handler.go

        役割: [ロジック/振る舞い] パーツカテゴリ別（射撃、格闘など）の行動処理戦略。

        内容: `ActionHandler` インターフェースと、その実装（`ShootActionHandler`, `MeleeActionHandler`など）を定義。主にターゲット解決ロジックをカプセル化する。新しいパーツカテゴリを追加する場合や、既存カテゴリのターゲット解決方法を変更する場合に編集する。

    game_end_system.go

        役割: [ロジック/振る舞い] ゲーム終了条件判定システム。

        内容: `CheckGameEndSystem` を定義し、リーダー機の破壊やチーム全滅といった勝利・敗北条件を判定する。ゲームの勝敗ルールを変更する場合に編集する。

    gauge_system.go

        役割: [ロジック/振る舞い] チャージゲージおよびクールダウンゲージの進行管理システム。

        内容: `UpdateGaugeSystem` を定義し、`ChargingStateComponent` または `CooldownStateComponent` を持つエンティティのゲージを進行させ、完了時には状態を遷移させる。ゲージのたまり方や速度に関するルールを変更する場合に編集する。

    state_effect_system.go

        役割: [ロジック/振る舞い] 状態遷移時の副作用処理システム。

        内容: `ProcessStateEffectsSystem` を定義し、`JustBecameIdleTag` などの一時タグが付与されたエンティティに対して、ゲージリセットなどの副作用処理を行い、その後タグを除去する。特定の状態に遷移した直後に行うべき処理を追加・変更する場合に編集する。

Game Logic & AI (戦闘ルールと思考)

    battle_logic.go

        役割: 戦闘中のコアな計算ロジック（Calculator群）。

        内容: `DamageCalculator`、`HitCalculator`、`TargetSelector`、`PartInfoProvider` を定義。これらは、具体的な計算式や選択アルゴリズムを実装し、アクション修飾システムやアクション実行ロジックから利用される。命中率の計算式、ダメージの算出式、防御の成否判定、基本的なターゲットの絞り込みルールなどを変更する場合に編集する。

    ai.go

        役割: 敵（AI）の思考ルーチン。

        内容: `aiSelectAction`（AIの行動全体を決定するエントリーポイント）、性格別ターゲット選択戦略関数群（`selectCrusherTarget`など）、パーツ選択戦略関数群（`SelectFirstAvailablePart`など）を定義。AIの行動パターン、ターゲット選択基準、使用パーツの優先順位などを変更・追加する場合に編集する。

    ai_input_system.go

        役割: [ロジック/振る舞い] AIの入力処理システム。

        内容: `UpdateAIInputSystem` を定義し、アイドル状態のAI制御メダロットに対して `aiSelectAction` を呼び出し、行動を決定させる。AIが行動を開始する条件やタイミングを変更する場合に編集する。

    player_actions.go

        役割: プレイヤーの行動選択に関連するヘルパー関数。

        内容: プレイヤーが行動を選択する際の、ターゲット候補の選択などを補助する。

    player_input_system.go

        役割: [ロジック/振る舞い] プレイヤーの入力処理システム。

        内容: `UpdatePlayerInputSystem` を定義し、アイドル状態のプレイヤー制御メダロットを見つけ出し、行動選択待ちキュー (`BattleScene` の `playerActionPendingQueue`) に追加する。プレイヤーが操作可能になる条件や、その際の処理を変更する場合に編集する。

UI (ユーザーインターフェース)

    ui.go

        役割: 戦闘画面UI全体のレイアウトと管理。

        内容: 左右の情報パネル、中央のバトルフィールドといったUIの骨格を組み立て、モーダルウィンドウの表示/非表示などを管理する。

    battlefield_widget.go

        役割: 中央のバトルフィールド描画。

        内容: メダロットアイコン、ホームマーカー、ゲージ、ターゲットインジケーターなどの描画処理。

    ui_info_panels.go

        役割: 左右の情報パネル（HPゲージなど）の作成と更新。

    ui_action_modal.go

        役割: プレイヤーの行動選択モーダルウィンドウ。

    ui_message_window.go

        役割: 画面下のメッセージウィンドウ（「～の攻撃！」など）。

Data & Utilities (データ定義と補助機能)

    types.go

        役割: プロジェクト全体で使われる基本的な型や定数の定義。

        内容: TeamID, PartSlotKey, StateTypeのような型定義や、constで定義される定数を集約する。

    entity_utils.go

        役割: エンティティやコンポーネント操作に関するユーティリティ関数。

        内容: `ChangeState`（状態遷移と一時タグ付与）、`ResetAllEffects` など、複数の場所から利用されるエンティティ操作関連のヘルパー関数をまとめる。エンティティの状態変更や、汎用的な効果リセット処理などを変更する場合に編集する。

    csv_loader.go

        役割: dataフォルダにあるCSVファイルの読み込み/保存。

        内容: パーツ、メダル、メダロット構成のデータをファイルから読み込む。